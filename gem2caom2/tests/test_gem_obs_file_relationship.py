# ***********************************************************************
# ******************  CANADIAN ASTRONOMY DATA CENTRE  *******************
# *************  CENTRE CANADIEN DE DONNÉES ASTRONOMIQUES  **************
#
#  (c) 2025.                            (c) 2025.
#  Government of Canada                 Gouvernement du Canada
#  National Research Council            Conseil national de recherches
#  Ottawa, Canada, K1A 0R6              Ottawa, Canada, K1A 0R6
#  All rights reserved                  Tous droits réservés
#
#  NRC disclaims any warranties,        Le CNRC dénie toute garantie
#  expressed, implied, or               énoncée, implicite ou légale,
#  statutory, of any kind with          de quelque nature que ce
#  respect to the software,             soit, concernant le logiciel,
#  including without limitation         y compris sans restriction
#  any warranty of merchantability      toute garantie de valeur
#  or fitness for a particular          marchande ou de pertinence
#  purpose. NRC shall not be            pour un usage particulier.
#  liable in any event for any          Le CNRC ne pourra en aucun cas
#  damages, whether direct or           être tenu responsable de tout
#  indirect, special or general,        dommage, direct ou indirect,
#  consequential or incidental,         particulier ou général,
#  arising from the use of the          accessoire ou fortuit, résultant
#  software.  Neither the name          de l'utilisation du logiciel. Ni
#  of the National Research             le nom du Conseil National de
#  Council of Canada nor the            Recherches du Canada ni les noms
#  names of its contributors may        de ses  participants ne peuvent
#  be used to endorse or promote        être utilisés pour approuver ou
#  products derived from this           promouvoir les produits dérivés
#  software without specific prior      de ce logiciel sans autorisation
#  written permission.                  préalable et particulière
#                                       par écrit.
#
#  This file is part of the             Ce fichier fait partie du projet
#  OpenCADC project.                    OpenCADC.
#
#  OpenCADC is free software:           OpenCADC est un logiciel libre ;
#  you can redistribute it and/or       vous pouvez le redistribuer ou le
#  modify it under the terms of         modifier suivant les termes de
#  the GNU Affero General Public        la “GNU Affero General Public
#  License as published by the          License” telle que publiée
#  Free Software Foundation,            par la Free Software Foundation
#  either version 3 of the              : soit la version 3 de cette
#  License, or (at your option)         licence, soit (à votre gré)
#  any later version.                   toute version ultérieure.
#
#  OpenCADC is distributed in the       OpenCADC est distribué
#  hope that it will be useful,         dans l’espoir qu’il vous
#  but WITHOUT ANY WARRANTY;            sera utile, mais SANS AUCUNE
#  without even the implied             GARANTIE : sans même la garantie
#  warranty of MERCHANTABILITY          implicite de COMMERCIALISABILITÉ
#  or FITNESS FOR A PARTICULAR          ni d’ADÉQUATION À UN OBJECTIF
#  PURPOSE.  See the GNU Affero         PARTICULIER. Consultez la Licence
#  General Public License for           Générale Publique GNU Affero
#  more details.                        pour plus de détails.
#
#  You should have received             Vous devriez avoir reçu une
#  a copy of the GNU Affero             copie de la Licence Générale
#  General Public License along         Publique GNU Affero avec
#  with OpenCADC.  If not, see          OpenCADC ; si ce n’est
#  <http://www.gnu.org/licenses/>.      pas le cas, consultez :
#                                       <http://www.gnu.org/licenses/>.
#
#  $Revision: 4 $
#
# ***********************************************************************
#

import os

from unittest.mock import Mock

from gem2caom2 import obs_file_relationship, main_app, util

import gem_mocks


def test_is_processed():
    tests = {
        'c2016may18_sci128': False,
        'abu01aug16_001': False,
        'ag2003feb19_6.0001': True,
        'TX06A_flt.2511': True,
        'GS20141226S0203_BIAS': True,
        'N20070819S0339_dark': True,
        'N20110927S0170_fringe': True,
        'N20120320S0328_stack_fringe': True,
        'N20130404S0512_flat': True,
        'N20140313S0072_flat': True,
        'N20141109S0266_bias': True,
        'N20150804S0348_dark': True,
        'N20160403S0236_flat_pasted': True,
        'S20120922S0406': False,
        'S20131007S0067_fringe': True,
        'S20140124S0039_dark': True,
        'S20141129S0331_dark': True,
        'S20161227S0051': False,
        'fmrgN20020413S0120_add': True,
        'gS20181219S0216_flat': True,
        'gS20190301S0556_bias': True,
        'mfrgS20041117S0073_add': True,
        'mfrgS20160310S0154_add': True,
        'mrgN20041016S0095': True,
        'mrgN20050831S0770_add': True,
        'mrgN20160311S0691_add': True,
        'mrgS20120922S0406': True,
        'mrgS20160901S0122_add': True,
        'mrgS20181016S0184_fringe': True,
        'rS20121030S0136': True,
        'rgS20100212S0301': True,
        'rgS20100316S0366': True,
        'rgS20130103S0098_FRINGE': True,
        'rgS20131109S0166_FRINGE': True,
        'rgS20161227S0051_fringe': True,
        'p2004may20_0048_FLAT': True,
        'p2004may19_0255_COMB': True,
        'P2003JAN14_0148_DARK': True,
        'P2002FEB03_0045_DARK10SEC': True,
        'P2002DEC02_0161_SUB': True,
        'P2002DEC02_0075_SUB.0001': True,
        'N20191219A0004b': False,
        'N20120825S0597_arc': True,
        'rgN20091120S0124_FRINGE': True,
    }
    for ii in tests:
        assert obs_file_relationship.is_processed(ii) == tests[ii], f'failed {ii}'

ORIGINAL_DATA_LABELS = {
    '01DEC05_004': 'GS-2001B-Q-31-9-9004',
    '01MAY08_023': 'GN-2001A-C-4-11-9023',
    '01sep20_044': 'GN-2001B-DD-1-16-044',
    '02jul07.0034': 'GS-CAL20020707-8-0034',
    '02jul07.0040': 'GS-CAL20020707-9-0040',
    '02jul07.0186': 'GS-2002A-Q-13-2-0186',
    '02jun24.0057': 'GS-CAL20020624-9-0057',
    '02jun25.0071': 'GS-2002A-Q-7-1-0071',
    '02jun25.0115': 'GS-CAL20020625-10-0115',
    '02jun25.0121': 'GS-CAL20020625-11-0121',
    '02nov05.0001': 'GS-CAL20021105-1-0001',
    '02nov05.0011': 'GS-2002B-DS-1-41-0011',
    '02nov05.0016': 'GS-2002B-DS-1-41-0016',
    '02nov05.0072': 'GS-2002B-DS-1-31-0072',
    '02nov06.0031': 'GS-2002B-DS-1-46-0031',
    '02nov06.0042': 'GS-2002B-DS-1-46-0042',
    '02nov10.0008': 'GS-CAL20021110-2-0008',
    '02nov10.0174': 'GS-CAL20021110-6-0174',
    '02nov12.0024': 'GS-CAL20021112-3-0024',
    '02nov12.0043': 'GS-CAL20021112-4-0043',
    '02nov12.0455': 'GS-CAL20021112-26-0455',
    '02oct30.0205': 'GS-2002B-Q-5-20-0205',
    '02sep04.0230': 'GS-2002B-DD-2-6-0230',
    '2001nov16_0164': 'GS-2001B-DD-4-1-0002',
    '2002APR23_591': 'GN-2002A-DD-1-319-591',
    '2002APR24_007': 'GN-CAL20020424-1-007',
    '2002dec02_0161': 'GS-2002B-Q-22-13-0161',
    '2002jun10_0171': 'GS-2002A-DD-1-17-0171',
    '2002may12_0277': 'GS-CAL20020512-9-0277',
    '2003apr24_0080': 'GS-2003A-Q-13-15-0080',
    '2003aug20_0073': 'GS-2003B-Q-51-27-0073',
    '2003jan05_0082': 'GS-CAL20030105-2-0072',
    '2003jul01_3598': 'GS-2003A-Q-3-22-3598',
    '2003jun30_3384': 'GS-CAL20030630-1-3384',
    '2003jun30_3385': 'GS-CAL20030630-1-3385',
    '2003jun30_3463': 'GS-CAL20030630-4-3463',
    '2003jun30_3507': 'GS-2003A-Q-14-2-3507',
    '2003jun30_3532': 'GS-CAL20030630-11-3532',
    '2003mar03_0052': 'GS-CAL20030303-7-0006',
    '2003mar08_1055': 'GS-CAL20030308-4-1055',
    '2003mar09_1161': 'GS-2003A-Q-24-1-1161',
    '2003mar09_1204': 'GS-2003A-Q-10-19-1204',
    '2003mar09_1247': 'GS-CAL20030309-9-1247',
    '2003mar13_1769': 'GS-CAL20030313-3-1769',
    '2003mar15_2027': 'GS-CAL20030315-18-2027',
    '2003mar20_2731': 'GS-CAL20030320-3-2731',
    '2004may19_0255': 'GS-2004A-Q-6-27-0255',
    '2006apr02_0073': 'GS-2006A-DD-1-1-0073',
    '2006apr07_0258': 'GS-2006A-C-10-1-0258',
    '2006dec10_0052': 'GS-2006B-C-8-2-0052',
    '2007sep15_0001': 'GS-2007B-Q-214-45-0001',
    'GS20141226S0203_BIAS': 'GS-CAL20141226-7-026-G-BIAS',
    'N20020620S0021': 'GN-2002A-C-5-1-001',
    'N20020620S0035': 'GN-2002A-C-5-1-015',
    'N20020620S0315': 'GN-2002A-C-5-21-002',
    'N20030104S0065': 'GN-CAL20030104-14-001',
    'N20030104S0161': 'GN-CAL20030104-18-003',
    'N20030107S0163': 'GN-2003A-Q-22-3-004',
    'N20030325S0098': 'GN-2003A-Q-51-2-004',
    'N20030325S0353': 'GN-CAL20030325-21-003',
    'N20030912S0301': 'GN-2003B-C-3-66-001',
    'N20050826S0137': 'GN-2005B-Q-16-85-001',
    'N20060413S0129': 'GN-CAL20060413-7-001',
    'N20060418S0123': 'GN-2006A-Q-58-9-007',
    'N20060705S0054': 'GN-2006A-C-14-49-002',
    'N20060723S0132': 'GN-2006A-C-11-670-006',
    'N20061217S0228': 'GN-2006B-C-9-17-034',
    'N20070310S0156': 'GN-2007A-C-11-234-001',
    'N20070818S0031': 'GN-2007B-Q-75-63-002',
    'N20070819S0339_dark': 'GN-2007B-Q-107-150-004_DARK',
    'N20071219S0193': 'GN-2007B-Q-112-14-018',
    'N20080308S0086': 'GN-CAL20080308-8-016',
    'N20080612S0038': 'GN-2008A-Q-43-6-002',
    'N20090105S0057': 'GN-2008B-C-3-2-009',
    'N20090105S0060': 'GN-2008B-C-3-2-012',
    'N20090313S0180': 'GN-2009A-Q-21-115-001',
    'N20090918S0386': 'GN-2009B-Q-52-332-011',
    'N20100104S0208': 'GN-2009B-Q-121-15-001',
    'N20100104S0210': 'GN-2009B-Q-121-15-003',
    'N20100115S0346': 'GN-2010A-Q-35-10-002',
    'N20100116S0154': 'GN-2009B-Q-3-64-002',
    'N20100131S0131': 'GN-2009B-C-1-62-001',
    'N20100620S0126': 'GN-2010A-Q-44-175-015',
    'N20100722S0185': 'GN-2010B-SV-142-10-007',
    'N20100915S0167': 'GN-2010B-Q-2-44-003',
    'N20110127S0219': 'GN-2010B-C-3-21-002',
    'N20110318S0581': 'GN-2011A-Q-87-69-001',
    'N20110323S0235': 'GN-2011A-Q-53-42-007',
    'N20110927S0170_fringe': 'GN-CAL20110927-900-170',
    'N20120101S0195': 'GN-2011B-Q-68-116-013',
    'N20120102S0213': 'GN-2011B-Q-63-126-005',
    'N20120102S0663': 'GN-2011B-Q-59-70-016',
    'N20120103S0100': 'GN-2011B-Q-7-193-010',
    'N20120103S0134': 'GN-2011B-Q-7-193-044',
    'N20120104S0167': 'GN-2011B-Q-63-101-006',
    'N20120105S0344': 'GN-2011A-Q-31-21-005',
    'N20120118S0441': 'GN-2011B-Q-28-10-002',
    'N20120320S0328_stack_fringe': 'GN-CAL20120320-900-328',
    'N20120405S0322': 'GN-2012A-Q-57-151-005',
    'N20120411S0279': 'GN-2012A-Q-2-22-007',
    'N20120825S0597_arc': 'GN-2012B-Q-110-64-001',
    'N20120905S0122': 'GN-2012A-Q-124-1-003',
    'N20120905S0122': 'GN-2012A-Q-124-1-003',
    'N20120905S0122_arc': 'GN-2012A-Q-124-1-003',
    'N20120909S0132': 'GN-2012B-Q-73-172-002',
    'N20121229S0118': 'GN-2012B-Q-51-108-001',
    'N20130404S0512_flat': 'GN-2013A-Q-63-54-051_FLAT',
    'N20130408S0105': 'GN-2013A-Q-71-86-031',
    'N20130419S0198': 'GN-2013A-Q-71-102-086',
    'N20131203S0006': 'GN-2013B-Q-28-150-002',
    'N20140313S0072_flat': 'GN-2013B-Q-75-163-011_STACK',
    'N20141109S0266_bias': 'GN-CAL20141109-2-001-BIAS',
    'N20141203S0891': 'GN-2014B-C-1-157-100',
    'N20150216S0129': 'GN-2015A-Q-36-15-001',
    'N20150216S0142': 'GN-2015A-Q-91-5-002',
    'N20150217S0274': 'GN-CAL20150217-2-003',
    'N20150217S0380': 'GN-2015A-C-2-96-002',
    'N20150220S0320': 'GN-2015A-C-4-24-086',
    'N20150404S0726': 'GN-2015A-C-1-20-001',
    'N20150404S0872': 'GN-2015A-C-1-27-001',
    'N20150405S0028': 'GN-2015A-C-1-27-071',
    'N20150604G0003': 'GN-CAL20150604-1000-1072',
    'N20150604G0014': 'GN-CAL20150604-1000-1081',
    'N20150804S0348_dark': 'GN-2015B-Q-53-138-061_STACK',
    'N20150807G0044': 'GN-2015B-Q-1-12-1003',
    'N20150807G0044i': 'GN-2015B-Q-1-12-1003',
    'N20150807G0044m': 'GN-2015B-Q-1-12-1003',
    'N20150807G0046': 'GN-CAL20150807-1000-1035',
    'N20150929S0013': 'GN-CAL20150925-2-007',
    'N20151129S0307': 'GN-2015B-Q-34-55-040',
    'N20151213S0022': 'GN-CAL20151213-6-002',
    'N20160123S0097': 'GN-2015B-SV-101-1061-005',
    'N20160202S0098': 'GN-CAL20160202-3-039',
    'N20160403S0236_flat_pasted': 'GN-CAL20160404-7-017-FLAT',
    'N20160426S0092': 'GN-2016A-Q-35-107-001',
    'N20161007S0382': 'GN-2016B-Q-27-31-007',
    'N20170201S0246': 'GN-2017A-Q-44-25-031',
    'N20170210S0013': 'GN-CAL20170209-5-003',
    'N20170302S0331': 'GN-2017A-SV-1-98-331',
    'N20170523S0331': 'GN-2017A-Q-70-214-001',
    'N20171106S0187': 'GN-2017B-LP-16-470-002',
    'N20180224S0063': 'GN-CAL20180224-3-001',
    'N20190313A0002b': 'GN-2019A-Q-214-0-0',
    'N20190313A0002r': 'GN-2019A-Q-214-0-0',
    'N20191219A0001b': 'GN-2020A-Q-132-0-0',
    'N20191219A0001r': 'GN-2020A-Q-132-0-0',
    'N20200103S0434': 'GN-CAL20200104-13-001',
    'N20200210S0077': 'GN-CAL20200210-22-076-BIAS',
    'N20200210S0077': 'GN-CAL20200210-22-076',
    'N20200210S0077_bias': 'GN-CAL20200210-22-076-BIAS',
    'N20211017S0139': 'GN-2021B-Q-110-28-126',
    'N20220915S0113': 'GN-CAL20220915-20-001',
    'N20241227M0103': 'GN-CAL20241227-0-0',
    'N20250101M0624': 'GN-CAL20250101-0-0',
    'N20250101M0656': 'GN-CAL20250101-0-0',
    'N20250102M0564': 'GN-2024B-CAL-201-0-0',
    'N20250103M0079': 'GN-CAL20250103-0-0',
    'P2002DEC02_0075_SUB.0001': 'GS-CAL20021202-3-0075',
    'P2002DEC02_0161_SUB.0001': 'GS-2002B-Q-22-13-0161',
    'P2002DEC02_0161_SUB': 'GS-2002B-Q-22-13-0161',
    'P2002DEC02_0161_SUB': 'GS-2002B-Q-22-13-0161',
    'P2002FEB03_0045_DARK10SEC': 'GS-CAL20020203-4-0045',
    'P2003JAN14_0148_DARK': 'GS-CAL20030114-7-0148',
    'S20030218S0027': 'GS-2003A-Q-6-1-002',
    'S20030218S0027': 'GS-2003A-Q-6-1-002',
    'S20030218S0042': 'GS-2003A-Q-6-1-002',
    'S20030218S0042': 'GS-2003A-Q-6-1-002',
    'S20030730S0036': 'GS-CAL20030730-10-006',
    'S20031218S0049': 'GS-CAL20031218-1-034',
    'S20040124S0077': 'GS-2003B-Q-5-29-003',
    'S20040212S0191': 'GS-2004A-SV-1-1-002',
    'S20040212S0281': 'GS-2004A-SV-1-4-024',
    'S20041101S0215': 'GS-2004B-Q-19-20-023',
    'S20050102S0024': 'GS-CAL20050102-1-001',
    'S20050601S0032': 'GS-CAL20050601-3-002',
    'S20050601S0411': 'GS-CAL20050601-24-035',
    'S20050621S0037': 'GS-2005A-Q-15-1-001',
    'S20050718S0172': 'GS-2005A-Q-50-55-003',
    'S20050824S0106': 'GS-2005B-SV-302-1-009',
    'S20050825S0143': 'GS-2005B-SV-301-16-005',
    'S20050918S0058': 'GS-2005B-Q-10-22-003',
    'S20051027S0089': 'GS-2005B-SV-302-20-001',
    'S20060101S0075': 'GS-2005B-Q-22-17-006',
    'S20060103S0143': 'GS-2005B-Q-22-29-004',
    'S20060122S0004': 'GS-2005B-Q-27-4-001',
    'S20060125S0027': 'GS-CAL20060125-1-002',
    'S20060128S0316': 'GS-2005B-Q-27-33-001',
    'S20060131S0110': 'GS-2005B-Q-54-2-004',
    'S20060620S0066': 'GS-2006A-Q-48-15-002',
    'S20070113S0060': 'GS-2006B-Q-7-32-008',
    'S20070130S0048': 'GS-2006B-Q-47-76-003',
    'S20080526S0024': 'GS-2008A-Q-41-26-013',
    'S20080610S0045': 'GS-2008A-C-5-35-002',
    'S20090620S0145': 'GS-2009A-Q-30-6-007',
    'S20100102S0035': 'GS-2009B-Q-14-129-029',
    'S20100110S0026': 'GS-CAL20100110-1-026',
    'S20100218S0028': 'GS-2009B-Q-21-19-001',
    'S20101028S0134': 'GS-CAL20101028-5-004',
    'S20101227S0023': 'GS-2010B-Q-20-151-001',
    'S20120605S0053': 'GS-2012A-SV-101-6-009',
    'S20120922S0372': 'GS-2012A-Q-7-31-001',
    'S20120922S0406': 'GS-2012B-Q-1-32-002',
    'S20130126S0134': 'GS-2012B-SV-499-21-002',
    'S20130201S0246': 'GS-CAL20130201-3-017',
    'S20130216S0276': 'GS-2013A-Q-21-16-002',
    'S20130528S0043': 'GS-2013A-Q-39-158-008',
    'S20130922S0130': 'GS-2013B-Q-75-187-001',
    'S20130922S0130_arc': 'GS-2013B-Q-75-187-001',
    'S20131007S0067_fringe': 'GS-CAL20131007-900-067',
    'S20140109S0210': 'GS-CAL20140109-3-009',
    'S20140113S0002': 'GS-2013B-DD-1-13-002',
    'S20140113S0167': 'GS-2013B-Q-61-8-008',
    'S20140122S0227': 'GS-2013B-Q-26-19-004',
    'S20140124S0039_dark': 'GS-2013B-Q-16-277-019_STACK',
    'S20140315S0348': 'GS-CAL20140315-4-004',
    'S20140317S0028': 'GS-CAL20140316-5-012',
    'S20140321S0011': 'GS-CAL20140320-7-011',
    'S20140323S0255': 'GS-CAL20140323-6-014',
    'S20140422S0167': 'GS-2014A-SV-408-6-003',
    'S20141129S0331_dark': 'GS-CAL20141129-1-001_DARK',
    'S20141130S0001': 'GS-CAL20141129-3-001',
    'S20150101S0261': 'GS-2014B-Q-60-8-071',
    'S20150103S0144': 'GS-2014B-Q-17-53-030',
    'S20150103S0148': 'GS-2014B-Q-17-69-002',
    'S20150113S0186': 'GS-2014B-Q-60-11-012',
    'S20150129S0028': 'GS-2014B-Q-501-10-001',
    'S20150213S0110': 'GS-2015A-Q-60-126-001',
    'S20150410S0541': 'GS-CAL20150410-1-007',
    'S20150622S0011': 'GS-2015A-Q-63-328-014',
    'S20150625S0077': 'GS-2015A-Q-63-365-016',
    'S20150625S0230': 'GS-2015A-Q-63-406-001',
    'S20160220S0125': 'GS-2016A-C-1-86-003',
    'S20160224S0323': 'GS-CAL20160224-12-017',
    'S20160616S0034': 'GS-2016A-FT-18-54-002',
    'S20161227S0051': 'GS-CAL20161227-5-001',
    'S20170221S0005': 'GS-CAL20170221-1-005',
    'S20170905S0318': 'GS-2017A-Q-58-66-027',
    'S20171123S0166': 'GS-2017B-Q-45-156-079',
    'S20171123S0216': 'GS-2017B-Q-18-96-006',
    'S20171226S0358': 'GS-2017A-Q-28-280-012',
    'S20180313S0108': 'GS-2018A-FT-101-5-043',
    'S20181016S0184': 'GS-CAL20181016-5-001',
    'S20181023S0087': 'GS-CAL20181023-5-001',
    'S20181219S0216': 'GS-CAL20181219-4-012',
    'S20181230S0026': 'GS-2018B-SV-301-144-020',
    'S20191214S0301': 'GS-CAL20191214-1-029',
    'S20200118S0371': 'GS-CAL20200118-10-001',
    'S20201023Z0001b': 'GS-CAL20201023-0-0',
    'S20210522S0033': 'GS-2021A-Q-322-12-033',
    'S20210530S0047': 'GS-2021A-Q-416-20-001',
    'S20220203S0019': 'GS-CAL20220203-1-005',
    'S20220220S0198': 'GS-CAL20220220-3-012',
    'S20220912S0299': 'GS-2022B-Q-306-70-014',
    'S20221020S0034': 'GS-2022B-DD-101-31-004',
    'S20221115S0124': 'GS-2022B-Q-235-137-045',
    'S20230301S0170': 'GS-2023A-LP-103-23-017',
    'S20230516S0039': 'GS-2023A-SV-104-12-003',
    'S20230517S0047': 'GS-CAL20230517-12-001',
    'S20230518S0121': 'GS-2023A-SV-101-13-009',
    'S20231208S0060': 'GS-2023B-FT-104-11-001',
    'S20231224S0444': 'GS-CAL20231224-19-001',
    'S20240215S0050': 'GS-CAL20240215-15-001',
    'S20240601S0038_blue001_dragons': 'GS-2024A-LP-106-12-013-BLUE-001-SQ-DRAGONS',
    'S20240607S0038': 'GS-2024A-Q-144-3-004',
    'SDCH_20200131_0010': 'GS-CAL20200131-10-0',
    'SDCH_20200201_0023': 'GS-CAL20200202-23-0',
    'TX20071021_FLT.2037': 'GN-2007B-C-6-5-005-FLT',
    'TX20071021_RAW.2037': 'GN-2007B-C-6-5-005-RAW',
    'TX20071021_SUM.2037': 'GN-2007B-C-6-5-005-SUM',
    'TX20131117_flt.3002': None,
    'TX20131117_raw.3002': None,
    'TX20170321_flt.2505': None,
    'TX20170321_flt.2507': None,
    'fmrgN20020413S0120_add': 'GN-2002A-SV-78-7-003',
    'gS20171114S0185_bias': 'GS-CAL20171114-2-086-G-BIAS',
    'gS20181219S0216_flat': 'GS-CAL20181219-4-021-G-FLAT',
    'gS20190301S0556_bias': 'GS-CAL20190301-4-046-G-BIAS',
    'mfrgS20041117S0073_add': 'GS-2004B-Q-42-1-001-MFRG',
    'mfrgS20160310S0154_add': 'GS-2016A-Q-7-175-001-MFRG-ADD',
    'mrgN20041016S0095': 'GN-2004B-Q-30-1-001-MRG',
    'mrgN20050831S0770_add': 'GN-2005B-Q-28-32-001-MRG',
    'mrgN20060130S0149_add': 'GN-2006A-Q-90-1-001-MRG-ADD',
    'mrgN20160311S0691_add': 'GN-2016A-Q-68-46-001-MRG-ADD',
    'mrgS20101028S0134': 'GS-CAL20101028-5-004-MRG',
    'mrgS20120922S0406': 'GS-2012B-Q-1-32-002-MRG',
    'mrgS20160901S0122_add': 'GS-2016B-Q-72-23-001-MRG-ADD',
    'mrgS20181016S0184_fringe': 'GS-CAL20181016-5-001',
    'p2004may19_0255_COMB': 'GS-2004A-Q-6-27-0255-COMB-P',
    'p2004may20_0048_FLAT': 'GS-CAL20040520-7-0048-FLAT-P',
    'r01dec05_007': 'GS-2001B-Q-31-9-007',
    'rS20050916S0159': 'GS-2003B-Q-23-17-001-G',
    'rS20060306S0090': 'GS-2005B-Q-10-63-003-R',
    'rS20060412S0056': 'GS-2006A-Q-60-11-001-R',
    'rS20121030S0136': 'GS-2012B-Q-90-366-003-R',
    'rgS20100212S0301': 'GS-2010A-Q-36-5-246-RG',
    'rgS20100316S0366': 'GS-2010A-Q-36-6-358-RG',
    'rgS20130103S0098_FRINGE': 'GS-CAL20130103-3-001-RG-FRINGE',
    'rgS20131109S0166_FRINGE': 'GS-CAL20131109-17-001-RG-FRINGE',
    'rgS20161227S0051_fringe': 'GS-CAL20161227-5-001',
}

def test_repair_data_label(test_config):
    # test_config is present so that caom2pipe.StorageName.collection is set properly
    for file_id, original in ORIGINAL_DATA_LABELS.items():
        test_result = obs_file_relationship.repair_data_label(file_id, original, gem_mocks.LOOKUP[file_id][1])
        if file_id == 'S20181230S0025':
            # what happens when an entry is not found
            assert test_result == 'S20181230S0025', (
                f'repair failed for {file_id} actual {test_result} expected {gem_mocks.LOOKUP[file_id][0]}'
            )
        elif file_id == 'S20201023Z0001b':
            # Alopeke/Zorro have different observationID rules
            assert test_result == 'S20201023Z0001', (
                f'repair failed for {file_id} actual {test_result} expected {gem_mocks.LOOKUP[file_id][0]}'
            )
        else:
            assert test_result == gem_mocks.LOOKUP[file_id][0], (
                f'repair failed for {file_id} actual {test_result} expected {gem_mocks.LOOKUP[file_id][0]}'
            )


def test_repair_data_label_247():
    # unprocessed
    fid1 = 'S20131109S0166'
    dl1 = ['GS-CAL20131109-17-001']

    # processed with a correct data label that's maintained
    fid2 = 'rgS20131109S0166_FRINGE'
    dl2 = ['GS-CAL20131109-17-001-RG-FRINGE']
    #
    # should be GS-CAL20131109-17-001-RG-FRINGE

    # processed with an incorrect data label that has to be fixed
    fid3 = 'rgS20161227S0051_fringe'
    dl3 = ['GS-CAL20161227-5-001', 'GS-CAL20161227-5-001-RG-FRINGE']
    #
    # should be GS-CAL20161227-5-001-RG-FRINGE

    # the unprocessed that goes with the processed
    fid4 = 'S20161227S0051'
    dl4 = ['GS-CAL20161227-5-001']

    # the processed that goes with the unprocessed
    fid5 = 'N20110313S0188_fringe'
    dl5 = ['GN-CAL20110313-900-188']

    d = {
        fid1: dl1,
        fid2: dl2,
        fid3: dl3,
        fid4: dl4,
        fid5: dl5,
    }

    for key, value in d.items():
        index = 0 if len(value) == 1 else 1
        temp = obs_file_relationship.repair_data_label(key, value[0], util.Inst.UNKNOWN)
        assert temp == value[index], f'file id {key} expected {value[index]} actual {temp}'


test_subjects = [
    ['S20141226S0203', 'tmpfile22889S20141226S0203.fits[SCI,1]'],
    ['S20141226S0204', 'tmpfile22889S20141226S0204.fits[SCI,1]'],
    ['S20141226S0205', 'tmpfile22889S20141226S0205.fits[SCI,1]'],
    ['S20141226S0206', 'tmpfile22889S20141226S0206.fits[SCI,1]'],
    ['S20141226S0207', 'tmpfile22889S20141226S0207.fits[SCI,1]'],
    ['S20141226S0203', 'tmpfile22889S20141226S0203.fits[SCI,2]'],
    ['S20141226S0204', 'tmpfile22889S20141226S0204.fits[SCI,2]'],
    ['S20141226S0205', 'tmpfile22889S20141226S0205.fits[SCI,2]'],
    ['S20141226S0206', 'tmpfile22889S20141226S0206.fits[SCI,2]'],
    ['S20141226S0207', 'tmpfile22889S20141226S0207.fits[SCI,2]'],
    ['S20141226S0203', 'tmpfile22889S20141226S0203.fits[SCI,3]'],
    ['S20141226S0204', 'tmpfile22889S20141226S0204.fits[SCI,3]'],
    ['S20141226S0205', 'tmpfile22889S20141226S0205.fits[SCI,3]'],
    ['S20141226S0206', 'tmpfile22889S20141226S0206.fits[SCI,3]'],
    ['S20141226S0207', 'tmpfile22889S20141226S0207.fits[SCI,3]'],
    ['S20141226S0203', 'tmpfile22889S20141226S0203.fits[SCI,4]'],
    ['S20141226S0204', 'tmpfile22889S20141226S0204.fits[SCI,4]'],
    ['S20141226S0205', 'tmpfile22889S20141226S0205.fits[SCI,4]'],
    ['S20141226S0206', 'tmpfile22889S20141226S0206.fits[SCI,4]'],
    ['S20141226S0207', 'tmpfile22889S20141226S0207.fits[SCI,4]'],
    ['S20141226S0203', 'tmpfile22889S20141226S0203.fits[SCI,5]'],
    ['S20141226S0204', 'tmpfile22889S20141226S0204.fits[SCI,5]'],
    ['S20141226S0205', 'tmpfile22889S20141226S0205.fits[SCI,5]'],
    ['S20141226S0206', 'tmpfile22889S20141226S0206.fits[SCI,5]'],
    ['S20141226S0207', 'tmpfile22889S20141226S0207.fits[SCI,5]'],
    ['S20141226S0203', 'tmpfile22889S20141226S0203.fits[SCI,6]'],
    ['S20141226S0204', 'tmpfile22889S20141226S0204.fits[SCI,6]'],
    ['S20141226S0205', 'tmpfile22889S20141226S0205.fits[SCI,6]'],
    ['S20141226S0206', 'tmpfile22889S20141226S0206.fits[SCI,6]'],
    ['S20141226S0207', 'tmpfile22889S20141226S0207.fits[SCI,6]'],
    ['S20141226S0203', 'tmpfile22889S20141226S0203.fits[SCI,7]'],
    ['S20141226S0204', 'tmpfile22889S20141226S0204.fits[SCI,7]'],
    ['S20141226S0205', 'tmpfile22889S20141226S0205.fits[SCI,7]'],
    ['S20141226S0206', 'tmpfile22889S20141226S0206.fits[SCI,7]'],
    ['S20141226S0207', 'tmpfile22889S20141226S0207.fits[SCI,7]'],
    ['S20141226S0203', 'tmpfile22889S20141226S0203.fits[SCI,8]'],
    ['S20141226S0204', 'tmpfile22889S20141226S0204.fits[SCI,8]'],
    ['S20141226S0205', 'tmpfile22889S20141226S0205.fits[SCI,8]'],
    ['S20141226S0206', 'tmpfile22889S20141226S0206.fits[SCI,8]'],
    ['S20141226S0207', 'tmpfile22889S20141226S0207.fits[SCI,8]'],
    ['S20141226S0203', 'tmpfile22889S20141226S0203.fits[SCI,9]'],
    ['S20141226S0204', 'tmpfile22889S20141226S0204.fits[SCI,9]'],
    ['S20141226S0205', 'tmpfile22889S20141226S0205.fits[SCI,9]'],
    ['S20141226S0206', 'tmpfile22889S20141226S0206.fits[SCI,9]'],
    ['S20141226S0207', 'tmpfile22889S20141226S0207.fits[SCI,9]'],
    ['S20141226S0203', 'tmpfile22889S20141226S0203.fits[SCI,10]'],
    ['S20141226S0204', 'tmpfile22889S20141226S0204.fits[SCI,10]'],
    ['S20141226S0205', 'tmpfile22889S20141226S0205.fits[SCI,10]'],
    ['S20141226S0206', 'tmpfile22889S20141226S0206.fits[SCI,10]'],
    ['S20141226S0207', 'tmpfile22889S20141226S0207.fits[SCI,10]'],
    ['S20141226S0203', 'tmpfile22889S20141226S0203.fits[SCI,11]'],
    ['S20141226S0204', 'tmpfile22889S20141226S0204.fits[SCI,11]'],
    ['S20141226S0205', 'tmpfile22889S20141226S0205.fits[SCI,11]'],
    ['S20141226S0206', 'tmpfile22889S20141226S0206.fits[SCI,11]'],
    ['S20141226S0207', 'tmpfile22889S20141226S0207.fits[SCI,11]'],
    ['S20141226S0203', 'tmpfile22889S20141226S0203.fits[SCI,12]'],
    ['S20141226S0204', 'tmpfile22889S20141226S0204.fits[SCI,12]'],
    ['S20141226S0205', 'tmpfile22889S20141226S0205.fits[SCI,12]'],
    ['S20141226S0206', 'tmpfile22889S20141226S0206.fits[SCI,12]'],
    ['S20141226S0207', 'tmpfile22889S20141226S0207.fits[SCI,12]'],
    ['N20070819S0339', 'N20070819S0339.fits[SCI,1]'],
    ['N20070819S0340', 'N20070819S0340.fits[SCI,1]'],
    ['N20070819S0341', 'N20070819S0341.fits[SCI,1]'],
    ['N20070819S0342', 'N20070819S0342.fits[SCI,1]'],
    ['N20070819S0343', 'N20070819S0343.fits[SCI,1]'],
    ['N20070819S0344', 'N20070819S0344.fits[SCI,1]'],
    ['N20070819S0345', 'N20070819S0345.fits[SCI,1]'],
    ['N20070819S0339', 'N20070819S0339.fits[SCI,1]'],
    ['N20070819S0340', 'N20070819S0340.fits[SCI,1]'],
    ['N20070819S0341', 'N20070819S0341.fits[SCI,1]'],
    ['N20070819S0342', 'N20070819S0342.fits[SCI,1]'],
    ['N20070819S0343', 'N20070819S0343.fits[SCI,1]'],
    ['N20070819S0344', 'N20070819S0344.fits[SCI,1]'],
    ['N20070819S0345', 'N20070819S0345.fits[SCI,1]'],
    ['N20070819S0339', 'N20070819S0339.fits[SCI,1]'],
    ['N20070819S0340', 'N20070819S0340.fits[SCI,1]'],
    ['N20070819S0341', 'N20070819S0341.fits[SCI,1]'],
    ['N20070819S0342', 'N20070819S0342.fits[SCI,1]'],
    ['N20070819S0343', 'N20070819S0343.fits[SCI,1]'],
    ['N20070819S0344', 'N20070819S0344.fits[SCI,1]'],
    ['N20070819S0345', 'N20070819S0345.fits[SCI,1]'],
    ['N20130404S0512', 'tmp29851gemcombineN20130404S0512.fits[SCI,1]'],
    ['N20130404S0513', 'tmp29851gemcombineN20130404S0513.fits[SCI,1]'],
    ['N20130404S0514', 'tmp29851gemcombineN20130404S0514.fits[SCI,1]'],
    ['N20130404S0515', 'tmp29851gemcombineN20130404S0515.fits[SCI,1]'],
    ['N20130404S0516', 'tmp29851gemcombineN20130404S0516.fits[SCI,1]'],
    ['N20130404S0517', 'tmp29851gemcombineN20130404S0517.fits[SCI,1]'],
    ['N20130404S0518', 'tmp29851gemcombineN20130404S0518.fits[SCI,1]'],
    ['N20130404S0519', 'tmp29851gemcombineN20130404S0519.fits[SCI,1]'],
    ['N20130404S0520', 'tmp29851gemcombineN20130404S0520.fits[SCI,1]'],
    ['N20130404S0521', 'tmp29851gemcombineN20130404S0521.fits[SCI,1]'],
    ['N20130404S0512', 'tmp29851gemcombineN20130404S0512.fits[SCI,1]'],
    ['N20130404S0513', 'tmp29851gemcombineN20130404S0513.fits[SCI,1]'],
    ['N20130404S0514', 'tmp29851gemcombineN20130404S0514.fits[SCI,1]'],
    ['N20130404S0515', 'tmp29851gemcombineN20130404S0515.fits[SCI,1]'],
    ['N20130404S0516', 'tmp29851gemcombineN20130404S0516.fits[SCI,1]'],
    ['N20130404S0517', 'tmp29851gemcombineN20130404S0517.fits[SCI,1]'],
    ['N20130404S0518', 'tmp29851gemcombineN20130404S0518.fits[SCI,1]'],
    ['N20130404S0519', 'tmp29851gemcombineN20130404S0519.fits[SCI,1]'],
    ['N20130404S0520', 'tmp29851gemcombineN20130404S0520.fits[SCI,1]'],
    ['N20130404S0521', 'tmp29851gemcombineN20130404S0521.fits[SCI,1]'],
    ['N20130404S0512', 'tmp29851gemcombineN20130404S0512.fits[SCI,1]'],
    ['N20130404S0513', 'tmp29851gemcombineN20130404S0513.fits[SCI,1]'],
    ['N20130404S0514', 'tmp29851gemcombineN20130404S0514.fits[SCI,1]'],
    ['N20130404S0515', 'tmp29851gemcombineN20130404S0515.fits[SCI,1]'],
    ['N20130404S0516', 'tmp29851gemcombineN20130404S0516.fits[SCI,1]'],
    ['N20130404S0517', 'tmp29851gemcombineN20130404S0517.fits[SCI,1]'],
    ['N20130404S0518', 'tmp29851gemcombineN20130404S0518.fits[SCI,1]'],
    ['N20130404S0519', 'tmp29851gemcombineN20130404S0519.fits[SCI,1]'],
    ['N20130404S0520', 'tmp29851gemcombineN20130404S0520.fits[SCI,1]'],
    ['N20130404S0521', 'tmp29851gemcombineN20130404S0521.fits[SCI,1]'],
    ['N20141109S0266', 'tmpfile16849_1610gN20141109S0266.fits[SCI,1]'],
    ['N20141109S0267', 'tmpfile16849_1610gN20141109S0267.fits[SCI,1]'],
    ['N20141109S0269', 'tmpfile16849_1610gN20141109S0269.fits[SCI,1]'],
    ['N20141109S0268', 'tmpfile16849_1610gN20141109S0268.fits[SCI,1]'],
    ['N20141109S0270', 'tmpfile16849_1610gN20141109S0270.fits[SCI,1]'],
    ['N20141112S0002', 'tmpfile16849_1610gN20141112S0002.fits[SCI,1]'],
    ['N20141112S0005', 'tmpfile16849_1610gN20141112S0005.fits[SCI,1]'],
    ['N20141112S0001', 'tmpfile16849_1610gN20141112S0001.fits[SCI,1]'],
    ['N20141112S0003', 'tmpfile16849_1610gN20141112S0003.fits[SCI,1]'],
    ['N20141112S0004', 'tmpfile16849_1610gN20141112S0004.fits[SCI,1]'],
    ['N20141112S0093', 'tmpfile16849_1610gN20141112S0093.fits[SCI,1]'],
    ['N20141112S0091', 'tmpfile16849_1610gN20141112S0091.fits[SCI,1]'],
    ['N20141112S0095', 'tmpfile16849_1610gN20141112S0095.fits[SCI,1]'],
    ['N20141112S0092', 'tmpfile16849_1610gN20141112S0092.fits[SCI,1]'],
    ['N20141112S0094', 'tmpfile16849_1610gN20141112S0094.fits[SCI,1]'],
    ['N20141113S0115', 'tmpfile16849_1610gN20141113S0115.fits[SCI,1]'],
    ['N20141113S0116', 'tmpfile16849_1610gN20141113S0116.fits[SCI,1]'],
    ['N20141113S0118', 'tmpfile16849_1610gN20141113S0118.fits[SCI,1]'],
    ['N20141113S0117', 'tmpfile16849_1610gN20141113S0117.fits[SCI,1]'],
    ['N20141113S0119', 'tmpfile16849_1610gN20141113S0119.fits[SCI,1]'],
    ['N20141109S0266', 'tmpfile16849_1610gN20141109S0266.fits[SCI,2]'],
    ['N20141109S0267', 'tmpfile16849_1610gN20141109S0267.fits[SCI,2]'],
    ['N20141109S0269', 'tmpfile16849_1610gN20141109S0269.fits[SCI,2]'],
    ['N20141109S0268', 'tmpfile16849_1610gN20141109S0268.fits[SCI,2]'],
    ['N20141109S0270', 'tmpfile16849_1610gN20141109S0270.fits[SCI,2]'],
    ['N20141112S0002', 'tmpfile16849_1610gN20141112S0002.fits[SCI,2]'],
    ['N20141112S0005', 'tmpfile16849_1610gN20141112S0005.fits[SCI,2]'],
    ['N20141112S0001', 'tmpfile16849_1610gN20141112S0001.fits[SCI,2]'],
    ['N20141112S0003', 'tmpfile16849_1610gN20141112S0003.fits[SCI,2]'],
    ['N20141112S0004', 'tmpfile16849_1610gN20141112S0004.fits[SCI,2]'],
    ['N20141112S0093', 'tmpfile16849_1610gN20141112S0093.fits[SCI,2]'],
    ['N20141112S0091', 'tmpfile16849_1610gN20141112S0091.fits[SCI,2]'],
    ['N20141112S0095', 'tmpfile16849_1610gN20141112S0095.fits[SCI,2]'],
    ['N20141112S0092', 'tmpfile16849_1610gN20141112S0092.fits[SCI,2]'],
    ['N20141112S0094', 'tmpfile16849_1610gN20141112S0094.fits[SCI,2]'],
    ['N20141113S0115', 'tmpfile16849_1610gN20141113S0115.fits[SCI,2]'],
    ['N20141113S0116', 'tmpfile16849_1610gN20141113S0116.fits[SCI,2]'],
    ['N20141113S0118', 'tmpfile16849_1610gN20141113S0118.fits[SCI,2]'],
    ['N20141113S0117', 'tmpfile16849_1610gN20141113S0117.fits[SCI,2]'],
    ['N20141113S0119', 'tmpfile16849_1610gN20141113S0119.fits[SCI,2]'],
    ['N20141109S0266', 'tmpfile16849_1610gN20141109S0266.fits[SCI,3]'],
    ['N20141109S0267', 'tmpfile16849_1610gN20141109S0267.fits[SCI,3]'],
    ['N20141109S0269', 'tmpfile16849_1610gN20141109S0269.fits[SCI,3]'],
    ['N20141109S0268', 'tmpfile16849_1610gN20141109S0268.fits[SCI,3]'],
    ['N20141109S0270', 'tmpfile16849_1610gN20141109S0270.fits[SCI,3]'],
    ['N20141112S0002', 'tmpfile16849_1610gN20141112S0002.fits[SCI,3]'],
    ['N20141112S0005', 'tmpfile16849_1610gN20141112S0005.fits[SCI,3]'],
    ['N20141112S0001', 'tmpfile16849_1610gN20141112S0001.fits[SCI,3]'],
    ['N20141112S0003', 'tmpfile16849_1610gN20141112S0003.fits[SCI,3]'],
    ['N20141112S0004', 'tmpfile16849_1610gN20141112S0004.fits[SCI,3]'],
    ['N20141112S0093', 'tmpfile16849_1610gN20141112S0093.fits[SCI,3]'],
    ['N20141112S0091', 'tmpfile16849_1610gN20141112S0091.fits[SCI,3]'],
    ['N20141112S0095', 'tmpfile16849_1610gN20141112S0095.fits[SCI,3]'],
    ['N20141112S0092', 'tmpfile16849_1610gN20141112S0092.fits[SCI,3]'],
    ['N20141112S0094', 'tmpfile16849_1610gN20141112S0094.fits[SCI,3]'],
    ['N20141113S0115', 'tmpfile16849_1610gN20141113S0115.fits[SCI,3]'],
    ['N20141113S0116', 'tmpfile16849_1610gN20141113S0116.fits[SCI,3]'],
    ['N20141113S0118', 'tmpfile16849_1610gN20141113S0118.fits[SCI,3]'],
    ['N20141113S0117', 'tmpfile16849_1610gN20141113S0117.fits[SCI,3]'],
    ['N20141113S0119', 'tmpfile16849_1610gN20141113S0119.fits[SCI,3]'],
    ['N20141109S0266', 'tmpfile16849_1610gN20141109S0266.fits[SCI,4]'],
    ['N20141109S0267', 'tmpfile16849_1610gN20141109S0267.fits[SCI,4]'],
    ['N20141109S0269', 'tmpfile16849_1610gN20141109S0269.fits[SCI,4]'],
    ['N20141109S0268', 'tmpfile16849_1610gN20141109S0268.fits[SCI,4]'],
    ['N20141109S0270', 'tmpfile16849_1610gN20141109S0270.fits[SCI,4]'],
    ['N20141112S0002', 'tmpfile16849_1610gN20141112S0002.fits[SCI,4]'],
    ['N20141112S0005', 'tmpfile16849_1610gN20141112S0005.fits[SCI,4]'],
    ['N20141112S0001', 'tmpfile16849_1610gN20141112S0001.fits[SCI,4]'],
    ['N20141112S0003', 'tmpfile16849_1610gN20141112S0003.fits[SCI,4]'],
    ['N20141112S0004', 'tmpfile16849_1610gN20141112S0004.fits[SCI,4]'],
    ['N20141112S0093', 'tmpfile16849_1610gN20141112S0093.fits[SCI,4]'],
    ['N20141112S0091', 'tmpfile16849_1610gN20141112S0091.fits[SCI,4]'],
    ['N20141112S0095', 'tmpfile16849_1610gN20141112S0095.fits[SCI,4]'],
    ['N20141112S0092', 'tmpfile16849_1610gN20141112S0092.fits[SCI,4]'],
    ['N20141112S0094', 'tmpfile16849_1610gN20141112S0094.fits[SCI,4]'],
    ['N20141113S0115', 'tmpfile16849_1610gN20141113S0115.fits[SCI,4]'],
    ['N20141113S0116', 'tmpfile16849_1610gN20141113S0116.fits[SCI,4]'],
    ['N20141113S0118', 'tmpfile16849_1610gN20141113S0118.fits[SCI,4]'],
    ['N20141113S0117', 'tmpfile16849_1610gN20141113S0117.fits[SCI,4]'],
    ['N20141113S0119', 'tmpfile16849_1610gN20141113S0119.fits[SCI,4]'],
    ['N20141109S0266', 'tmpfile16849_1610gN20141109S0266.fits[SCI,5]'],
    ['N20141109S0267', 'tmpfile16849_1610gN20141109S0267.fits[SCI,5]'],
    ['N20141109S0269', 'tmpfile16849_1610gN20141109S0269.fits[SCI,5]'],
    ['N20141109S0268', 'tmpfile16849_1610gN20141109S0268.fits[SCI,5]'],
    ['N20141109S0270', 'tmpfile16849_1610gN20141109S0270.fits[SCI,5]'],
    ['N20141112S0002', 'tmpfile16849_1610gN20141112S0002.fits[SCI,5]'],
    ['N20141112S0005', 'tmpfile16849_1610gN20141112S0005.fits[SCI,5]'],
    ['N20141112S0001', 'tmpfile16849_1610gN20141112S0001.fits[SCI,5]'],
    ['N20141112S0003', 'tmpfile16849_1610gN20141112S0003.fits[SCI,5]'],
    ['N20141112S0004', 'tmpfile16849_1610gN20141112S0004.fits[SCI,5]'],
    ['N20141112S0093', 'tmpfile16849_1610gN20141112S0093.fits[SCI,5]'],
    ['N20141112S0091', 'tmpfile16849_1610gN20141112S0091.fits[SCI,5]'],
    ['N20141112S0095', 'tmpfile16849_1610gN20141112S0095.fits[SCI,5]'],
    ['N20141112S0092', 'tmpfile16849_1610gN20141112S0092.fits[SCI,5]'],
    ['N20141112S0094', 'tmpfile16849_1610gN20141112S0094.fits[SCI,5]'],
    ['N20141113S0115', 'tmpfile16849_1610gN20141113S0115.fits[SCI,5]'],
    ['N20141113S0116', 'tmpfile16849_1610gN20141113S0116.fits[SCI,5]'],
    ['N20141113S0118', 'tmpfile16849_1610gN20141113S0118.fits[SCI,5]'],
    ['N20141113S0117', 'tmpfile16849_1610gN20141113S0117.fits[SCI,5]'],
    ['N20141113S0119', 'tmpfile16849_1610gN20141113S0119.fits[SCI,5]'],
    ['N20141109S0266', 'tmpfile16849_1610gN20141109S0266.fits[SCI,6]'],
    ['N20141109S0267', 'tmpfile16849_1610gN20141109S0267.fits[SCI,6]'],
    ['N20141109S0269', 'tmpfile16849_1610gN20141109S0269.fits[SCI,6]'],
    ['N20141109S0268', 'tmpfile16849_1610gN20141109S0268.fits[SCI,6]'],
    ['N20141109S0270', 'tmpfile16849_1610gN20141109S0270.fits[SCI,6]'],
    ['N20141112S0002', 'tmpfile16849_1610gN20141112S0002.fits[SCI,6]'],
    ['N20141112S0005', 'tmpfile16849_1610gN20141112S0005.fits[SCI,6]'],
    ['N20141112S0001', 'tmpfile16849_1610gN20141112S0001.fits[SCI,6]'],
    ['N20141112S0003', 'tmpfile16849_1610gN20141112S0003.fits[SCI,6]'],
    ['N20141112S0004', 'tmpfile16849_1610gN20141112S0004.fits[SCI,6]'],
    ['N20141112S0093', 'tmpfile16849_1610gN20141112S0093.fits[SCI,6]'],
    ['N20141112S0091', 'tmpfile16849_1610gN20141112S0091.fits[SCI,6]'],
    ['N20141112S0095', 'tmpfile16849_1610gN20141112S0095.fits[SCI,6]'],
    ['N20141112S0092', 'tmpfile16849_1610gN20141112S0092.fits[SCI,6]'],
    ['N20141112S0094', 'tmpfile16849_1610gN20141112S0094.fits[SCI,6]'],
    ['N20141113S0115', 'tmpfile16849_1610gN20141113S0115.fits[SCI,6]'],
    ['N20141113S0116', 'tmpfile16849_1610gN20141113S0116.fits[SCI,6]'],
    ['N20141113S0118', 'tmpfile16849_1610gN20141113S0118.fits[SCI,6]'],
    ['N20141113S0117', 'tmpfile16849_1610gN20141113S0117.fits[SCI,6]'],
    ['N20141113S0119', 'tmpfile16849_1610gN20141113S0119.fits[SCI,6]'],
    ['N20150804S0348', 'tmp62119gemcombineN20150804S0348.fits[SCI,1]'],
    ['N20150804S0349', 'tmp62119gemcombineN20150804S0349.fits[SCI,1]'],
    ['N20150804S0350', 'tmp62119gemcombineN20150804S0350.fits[SCI,1]'],
    ['N20150804S0351', 'tmp62119gemcombineN20150804S0351.fits[SCI,1]'],
    ['N20150804S0352', 'tmp62119gemcombineN20150804S0352.fits[SCI,1]'],
    ['N20150804S0353', 'tmp62119gemcombineN20150804S0353.fits[SCI,1]'],
    ['N20150804S0354', 'tmp62119gemcombineN20150804S0354.fits[SCI,1]'],
    ['N20150804S0355', 'tmp62119gemcombineN20150804S0355.fits[SCI,1]'],
    ['N20150804S0356', 'tmp62119gemcombineN20150804S0356.fits[SCI,1]'],
    ['N20150804S0357', 'tmp62119gemcombineN20150804S0357.fits[SCI,1]'],
    ['N20150804S0348', 'tmp62119gemcombineN20150804S0348.fits[SCI,1]'],
    ['N20150804S0349', 'tmp62119gemcombineN20150804S0349.fits[SCI,1]'],
    ['N20150804S0350', 'tmp62119gemcombineN20150804S0350.fits[SCI,1]'],
    ['N20150804S0351', 'tmp62119gemcombineN20150804S0351.fits[SCI,1]'],
    ['N20150804S0352', 'tmp62119gemcombineN20150804S0352.fits[SCI,1]'],
    ['N20150804S0353', 'tmp62119gemcombineN20150804S0353.fits[SCI,1]'],
    ['N20150804S0354', 'tmp62119gemcombineN20150804S0354.fits[SCI,1]'],
    ['N20150804S0355', 'tmp62119gemcombineN20150804S0355.fits[SCI,1]'],
    ['N20150804S0356', 'tmp62119gemcombineN20150804S0356.fits[SCI,1]'],
    ['N20150804S0357', 'tmp62119gemcombineN20150804S0357.fits[SCI,1]'],
    ['N20150804S0348', 'tmp62119gemcombineN20150804S0348.fits[SCI,1]'],
    ['N20150804S0349', 'tmp62119gemcombineN20150804S0349.fits[SCI,1]'],
    ['N20150804S0350', 'tmp62119gemcombineN20150804S0350.fits[SCI,1]'],
    ['N20150804S0351', 'tmp62119gemcombineN20150804S0351.fits[SCI,1]'],
    ['N20150804S0352', 'tmp62119gemcombineN20150804S0352.fits[SCI,1]'],
    ['N20150804S0353', 'tmp62119gemcombineN20150804S0353.fits[SCI,1]'],
    ['N20150804S0354', 'tmp62119gemcombineN20150804S0354.fits[SCI,1]'],
    ['N20150804S0355', 'tmp62119gemcombineN20150804S0355.fits[SCI,1]'],
    ['N20150804S0356', 'tmp62119gemcombineN20150804S0356.fits[SCI,1]'],
    ['N20150804S0357', 'tmp62119gemcombineN20150804S0357.fits[SCI,1]'],
    ['N20160403S0236', 'rgN20160403S0236.fits[SCI,2]'],
    ['N20160403S0237', 'rgN20160403S0237.fits[SCI,2]'],
    ['N20160403S0238', 'rgN20160403S0238.fits[SCI,2]'],
    ['N20160403S0235', 'rgN20160403S0235.fits[SCI,2]'],
    ['N20160403S0240', 'rgN20160403S0240.fits[SCI,2]'],
    ['N20160403S0239', 'rgN20160403S0239.fits[SCI,2]'],
    ['N20160403S0234', 'rgN20160403S0234.fits[SCI,2]'],
    ['N20160403S0241', 'rgN20160403S0241.fits[SCI,2]'],
    ['N20160403S0229', 'rgN20160403S0229.fits[SCI,2]'],
    ['N20160403S0228', 'rgN20160403S0228.fits[SCI,2]'],
    ['N20160403S0230', 'rgN20160403S0230.fits[SCI,2]'],
    ['N20160403S0231', 'rgN20160403S0231.fits[SCI,2]'],
    ['N20160403S0233', 'rgN20160403S0233.fits[SCI,2]'],
    ['N20160403S0232', 'rgN20160403S0232.fits[SCI,2]'],
    ['N20160404S0141', 'rgN20160404S0141.fits[SCI,2]'],
    ['N20160404S0140', 'rgN20160404S0140.fits[SCI,2]'],
    ['N20160404S0139', 'rgN20160404S0139.fits[SCI,2]'],
    ['N20160404S0142', 'rgN20160404S0142.fits[SCI,2]'],
    ['N20160404S0143', 'rgN20160404S0143.fits[SCI,2]'],
    ['N20160404S0145', 'rgN20160404S0145.fits[SCI,2]'],
    ['N20160404S0144', 'rgN20160404S0144.fits[SCI,2]'],
    ['N20160404S0138', 'rgN20160404S0138.fits[SCI,2]'],
    ['N20160404S0137', 'rgN20160404S0137.fits[SCI,2]'],
    ['N20160404S0136', 'rgN20160404S0136.fits[SCI,2]'],
    ['N20160404S0135', 'rgN20160404S0135.fits[SCI,2]'],
    ['S20131007S0067', 'tmp71808gemcombineS20131007S0067.fits[SCI,1]'],
    ['S20131007S0068', 'tmp71808gemcombineS20131007S0068.fits[SCI,1]'],
    ['S20131007S0069', 'tmp71808gemcombineS20131007S0069.fits[SCI,1]'],
    ['S20131007S0067', 'tmp71808gemcombineS20131007S0067.fits[SCI,1]'],
    ['S20131007S0068', 'tmp71808gemcombineS20131007S0068.fits[SCI,1]'],
    ['S20131007S0069', 'tmp71808gemcombineS20131007S0069.fits[SCI,1]'],
    ['S20131007S0067', 'tmp71808gemcombineS20131007S0067.fits[SCI,1]'],
    ['S20131007S0068', 'tmp71808gemcombineS20131007S0068.fits[SCI,1]'],
    ['S20131007S0069', 'tmp71808gemcombineS20131007S0069.fits[SCI,1]'],
    ['S20140124S0039', 'tmp67553gemcombineS20140124S0039.fits[SCI,1]'],
    ['S20140124S0040', 'tmp67553gemcombineS20140124S0040.fits[SCI,1]'],
    ['S20140124S0041', 'tmp67553gemcombineS20140124S0041.fits[SCI,1]'],
    ['S20140124S0042', 'tmp67553gemcombineS20140124S0042.fits[SCI,1]'],
    ['S20140124S0043', 'tmp67553gemcombineS20140124S0043.fits[SCI,1]'],
    ['S20140124S0044', 'tmp67553gemcombineS20140124S0044.fits[SCI,1]'],
    ['S20140124S0039', 'tmp67553gemcombineS20140124S0039.fits[SCI,1]'],
    ['S20140124S0040', 'tmp67553gemcombineS20140124S0040.fits[SCI,1]'],
    ['S20140124S0041', 'tmp67553gemcombineS20140124S0041.fits[SCI,1]'],
    ['S20140124S0042', 'tmp67553gemcombineS20140124S0042.fits[SCI,1]'],
    ['S20140124S0043', 'tmp67553gemcombineS20140124S0043.fits[SCI,1]'],
    ['S20140124S0044', 'tmp67553gemcombineS20140124S0044.fits[SCI,1]'],
    ['S20140124S0039', 'tmp67553gemcombineS20140124S0039.fits[SCI,1]'],
    ['S20140124S0040', 'tmp67553gemcombineS20140124S0040.fits[SCI,1]'],
    ['S20140124S0041', 'tmp67553gemcombineS20140124S0041.fits[SCI,1]'],
    ['S20140124S0042', 'tmp67553gemcombineS20140124S0042.fits[SCI,1]'],
    ['S20140124S0043', 'tmp67553gemcombineS20140124S0043.fits[SCI,1]'],
    ['S20140124S0044', 'tmp67553gemcombineS20140124S0044.fits[SCI,1]'],
    ['S20141129S0331', 'tmp5862gemcombineS20141129S0331.fits[SCI,1]'],
    ['S20141129S0332', 'tmp5862gemcombineS20141129S0332.fits[SCI,1]'],
    ['S20141129S0333', 'tmp5862gemcombineS20141129S0333.fits[SCI,1]'],
    ['S20141129S0334', 'tmp5862gemcombineS20141129S0334.fits[SCI,1]'],
    ['S20141129S0335', 'tmp5862gemcombineS20141129S0335.fits[SCI,1]'],
    ['S20141129S0336', 'tmp5862gemcombineS20141129S0336.fits[SCI,1]'],
    ['S20141129S0337', 'tmp5862gemcombineS20141129S0337.fits[SCI,1]'],
    ['S20141129S0331', 'tmp5862gemcombineS20141129S0331.fits[SCI,1]'],
    ['S20141129S0332', 'tmp5862gemcombineS20141129S0332.fits[SCI,1]'],
    ['S20141129S0333', 'tmp5862gemcombineS20141129S0333.fits[SCI,1]'],
    ['S20141129S0334', 'tmp5862gemcombineS20141129S0334.fits[SCI,1]'],
    ['S20141129S0335', 'tmp5862gemcombineS20141129S0335.fits[SCI,1]'],
    ['S20141129S0336', 'tmp5862gemcombineS20141129S0336.fits[SCI,1]'],
    ['S20141129S0337', 'tmp5862gemcombineS20141129S0337.fits[SCI,1]'],
    ['S20141129S0331', 'tmp5862gemcombineS20141129S0331.fits[SCI,1]'],
    ['S20141129S0332', 'tmp5862gemcombineS20141129S0332.fits[SCI,1]'],
    ['S20141129S0333', 'tmp5862gemcombineS20141129S0333.fits[SCI,1]'],
    ['S20141129S0334', 'tmp5862gemcombineS20141129S0334.fits[SCI,1]'],
    ['S20141129S0335', 'tmp5862gemcombineS20141129S0335.fits[SCI,1]'],
    ['S20141129S0336', 'tmp5862gemcombineS20141129S0336.fits[SCI,1]'],
    ['S20141129S0337', 'tmp5862gemcombineS20141129S0337.fits[SCI,1]'],
    ['S20181219S0216', 'rgS20181219S0216[SCI,1]'],
    ['S20190301S0556', 'tmpfile31966S20190301S0556.fits[SCI,1]'],
    ['S20041117S0073', 'mfrgS20041117S0073_trn'],
    ['S20041117S0074', 'mfrgS20041117S0074_trn'],
    ['S20160310S0154', 'mfrgS20160310S0154_trn'],
    ['S20160310S0155', 'mfrgS20160310S0155_trn'],
    ['S20160310S0156', 'mfrgS20160310S0156_trn'],
    ['S20160310S0157', 'mfrgS20160310S0157_trn'],
    ['S20160310S0158', 'mfrgS20160310S0158_trn'],
    ['S20160310S0160', 'mfrgS20160310S0160_trn'],
    ['N20160311S0691', 'mrgN20160311S0691_trn'],
    ['N20160311S0692', 'mrgN20160311S0692_trn'],
    ['N20160311S0693', 'mrgN20160311S0693_trn'],
    ['N20160311S0694', 'mrgN20160311S0694_trn'],
    ['S20160901S0122', 'mrgS20160901S0122_trn'],
    ['S20160901S0123', 'mrgS20160901S0123_trn'],
    ['S20160901S0124', 'mrgS20160901S0124_trn'],
    ['S20160901S0125', 'mrgS20160901S0125_trn'],
    ['2004may20_0048', 'rawdir$2004may20_0048.fits'],
    ['2004may20_0049', 'rawdir$2004may20_0049.fits'],
    ['2004may20_0050', 'rawdir$2004may20_0050.fits'],
    ['N20060130S0149', 'mrgN20060130S0149_trn'],
]


def test_repair_provenance():
    getcwd_orig = os.getcwd
    os.getcwd = Mock(return_value=gem_mocks.TEST_DATA_DIR)
    try:
        for ii in test_subjects:
            temp = main_app._remove_processing_detritus([ii[1]], 'log_value')
            assert temp[0] == ii[0], f'error {temp[0]} should be {ii[0]}'
    finally:
        os.getcwd = getcwd_orig


def test_repair_data_label_2():
    repairs = {
        'rgS20180122S0236_fringe.fits': [
            'GS-CAL20180122-1-001',
            'GS-CAL20180122-1-001-RG-FRINGE',
        ],
        'gS20150906S0307_bias.fits': [
            'GS-CAL20150906-1-086-BIAS/MBIAS/G-BIAS',
            'GS-CAL20150906-1-086-g-bias',
        ],
    }
    for f_name in repairs.keys():
        result = obs_file_relationship.repair_data_label(f_name, repairs[f_name][0], util.Inst.UNKNOWN)
        assert repairs[f_name][1] == result, f'{result} should have been {repairs[f_name][1]}'


def test_repair_data_label_maroonx():
    repairs = {
        'N20241227M0103': [
            'GN-CAL20241227-0-0',
            'GN-CAL20241227-0-0103',
        ],
        'N20250101M0624': [
            'GN-CAL20250101-0-0',
            'GN-CAL20250101-0-0624',
        ],
        'N20250101M0656': [
            'GN-CAL20250101-0-0',
            'GN-CAL20250101-0-0656',
        ],
        'N20250102M0564': [
            'GN-2024B-CAL-201-0-0',
            'GN-2024B-CAL-201-0-0564',
        ],
        'N20250103M0079': [
            'GN-CAL20250103-0-0',
            'GN-CAL20250103-0-0079',
        ],
    }
    for f_name in repairs.keys():
        result = obs_file_relationship.repair_data_label(f_name, repairs[f_name][0], util.Inst.MAROONX)
        assert repairs[f_name][1] == result, f'{result} should have been {repairs[f_name][1]}'
